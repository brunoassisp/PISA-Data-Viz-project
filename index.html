<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <style>
      .y.axis {
        padding: 10px;
      }

      .axis text {
        font: 10px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
    </style>
    <script type="text/javascript">
      function draw(data) {
        "use strict";
        var margin = {top: 100, right: 100, bottom: 100, left: 100},
            width = 1100,
            height = 600,
            innerWidth = width - margin.left - margin.right,
            innerHeight = height - margin.top - margin.bottom;

        // Aggregate function
        function agg_country_var(leaves) {
            var frequency_list = [],
                percent_list = [];

            leaves.forEach(function(d) {
                frequency_list.push(d.frequency);
                percent_list.push(d.count_percent);
            });

            return {
              'frequency_list': frequency_list,
              'percent_list': percent_list
            };
        }

        // Aggregating data by Country and Behavior Variable
        var countries = d3.nest()
            .key(function(d) { return d.country })
            .key(function(d) { return d.variable })
            .rollup(agg_country_var)
            .entries(data);

        // x-axis labels
        var frequency_list = d3.map(data, function(d) {
          return d['frequency'];
        }).keys();

        // z-axis labels
        var countries_list = d3.map(data, function(d) {
          return d['country'];
        }).keys();

        var svg = d3.select('body')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Wrap everything in inner container
        var g = svg.append('g')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
            .attr('class', 'chart');

        // Create scales
        var frequency_scale = d3.scaleBand()
            .rangeRound([0, innerWidth])
            .domain(frequency_list);

        var percent_scale = d3.scaleLinear()
            .range([innerHeight, 0])
            .domain([0, 100]);

        var color_scale = d3.scaleOrdinal(d3.schemeCategory10)
            .domain(countries_list);

        // Create axis generators
        var xAxis = d3.axisBottom(frequency_scale);
        var yAxis = d3.axisLeft(percent_scale);

        // Create line generator
        var line = d3.line()
            .x(function(d) { debugger; return frequency_scale(d["frequency_list"]); })
            .y(function(d) { debugger; return percent_scale(d["percent_list"]); });

        // Append axes
        var percent_axis = g.append('g')
            .call(yAxis);

        var frequency_axis = g.append('g')
          .attr('transform', 'translate(0,' + innerHeight + ')')
          .call(xAxis);

        var country = g.selectAll(".country")
          .data(countries)
          .enter().append("g")
            .attr("class", "country");

        country.selectAll(".line")
          .data(function(d) { return d.values; })
          .enter().append("path")
            .attr("class", "line")
            .attr("d", function(l) { return line(l.value); })
            .style("stroke", function(d) { return color_scale(d['country']); });

        // country.append("path")
        //   .attr("class", "line")
        //   .attr("d", function(d) { return d.values.forEach(function(l) { return line(l.value); }); })
        //   .style("stroke", function(d) { return color_scale(d['country']); });

        // Draw circles
        var circles = g.selectAll('circle')
            .data(data)
            .enter()
            .append('circle')
            .attr('cx', function(d) {
                return frequency_scale(d['frequency']) + frequency_scale.bandwidth() / 2;
            })
            .attr('cy', function(d) {
                return percent_scale(d['count_percent']);
            })
            .attr('r', function(d) {
                return 2;
            })
            .attr('fill', function(d) {
                return 'black';
            })


      }
    </script>
  </head>
<body>
  <script type="text/javascript">

    // Change the datatype of some features
    function type(d) {
      d.count_percent = +d.count_percent;
      d.value_x = +d.value_x;
      d.value_y = +d.value_y;
      return d;
    }

    d3.csv("PISA_Math_Behavior.csv", type, draw);
  </script>
</body>
</html>
