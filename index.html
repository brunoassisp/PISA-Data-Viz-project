<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <style>
      .axis text {
        font: 10px sans-serif;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      h2 {
        color: black;
        position: relative;
        left: 100px;
        width: 450px;
        margin: 25px 0 0 0;
      }

      #countryMenu {
        position: absolute;
        left: 750px;
        top: 25px;
        width: 275px;
      }

      #variableMenu {
        position: absolute;
        left: 630px;
        top: 50px;
        width: 390px;
      }

      .dropdownLabel {
        float: left;
        margin: 0;
        margin-right: 10px;
        font-weight: bold;
      }

      .label {
        font-family: "Trebuchet MS";
        font-size: 13px;
      }

      .line {
        fill: none;
        stroke: #999999;
        stroke-width: 2px;
        stroke-opacity: .1;
        transition: stroke .5s, stroke-width .5s, stroke-opacity .5s;
      }

      circle {
        fill: none;
        stroke: #999999;
        stroke-opacity: .1;
        opacity: .1;
      }

      .selectedCircle {
        fill: #a9a9ff;
        stroke: #4f4fff;
        stroke-opacity: 1;
        opacity: 1;
        r: 5;
      }

      .selectedLine {
        stroke: #4f4fff;
        stroke-width: 4px;
        stroke-opacity: 1;
      }

      table {
        border-collapse: collapse;
      }

      tr th {
        border-bottom: 2px solid #4f4fff;
      }

      td, th {
        padding: 10px;
      }

      .tableCell {
        font-size: 11px;
        text-align: center;
      }

      .colHeader {
        border-right: 1px solid #999999;
        font-weight: bold;
      }
    </style>
    <script type="text/javascript">
      function draw(data) {
        "use strict";
        var margin = {top: 10, right: 100, bottom: 65, left: 100},
            width = 1100,
            height = 400,
            innerWidth = width - margin.left - margin.right,
            innerHeight = height - margin.top - margin.bottom;

        d3.select("body")
          .append("h2")
          .text("Students Behavior in Maths per Country");

        // Aggregate function
        function agg_country_var(leaves) {
            var frequency_list = [],
                percent_list = [];
            
            leaves.forEach(function(d) {
                frequency_list.push(d.frequency);
                percent_list.push(d.count_percent);
            });

            var country = d3.nest().key(function(d) {
                return d.country;
            }).entries(leaves);

            return {
              'country': country,
              'frequency_list': frequency_list,
              'percent_list': percent_list
            };
        }

        // Aggregating data by Country and Behavior Variable
        var countries = d3.nest()
            .key(function(d) { return d.variable })
            .rollup(agg_country_var)
            .entries(data);
        
        // x-axis labels
        var frequency_list = d3.map(data, function(d) {
          return d['frequency'];
        }).keys();

        // z-axis labels
        var countries_list = d3.map(data, function(d) {
          return d['country'];
        }).keys();

        var svg = d3.select('body')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Wrap everything in inner container
        var g = svg.append('g')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
            .attr('class', 'chart');

        // Create scales
        var frequency_scale = d3.scalePoint()
            .range([0, innerWidth])
            .domain(frequency_list);

        var percent_scale = d3.scaleLinear()
            .range([innerHeight, 0])
            .domain([0, 100]);

        // Create axis generators
        var xAxis = d3.axisBottom(frequency_scale);
        var yAxis = d3.axisLeft(percent_scale);

        // Create line generator
        var line = d3.line()
            .x(function(d) { return frequency_scale(d["frequency"]); })
            .y(function(d) { return percent_scale(d["count_percent"]); });

        // Append axes
        var percent_axis = g.append('g')
            .call(yAxis);

        // text label for the y axis
        g.append("text")
            .attr("class", "label yLabel")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - 60)
            .attr("x", margin.top - (innerHeight / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Count Percentage (%)"); 

        var frequency_axis = g.append('g')
            .attr('transform', 'translate(0,' + innerHeight + ')')
            .call(xAxis);

        // text label for the x axis
        g.append("text")
            .attr("class", "label xLabel")
            .attr("transform",
                  "translate(" + (innerWidth/2) + " ," + 
                                 (innerHeight + 40) + ")")
            .style("text-anchor", "middle")
            .text("Frequency");

        function generate_dropdown(menu, data, split="False") {
          menu
          .append("select")
          .selectAll("option")
              .data(data)
              .enter()
              .append("option")
              .attr("value", function(d){
                  return d;
              })
              .text(function(d){
                  if(split) {
                    return d.replace(/([A-Z])/g, ' $1')
                          .replace(/^./, function(str){ return str.toUpperCase(); })
                  }
                  return d;
              })
        }


        // Creating dropdowns
        var countryMenu = d3.select("#countryMenu");
        countryMenu.append("p")
            .attr("class", "dropdownLabel")
            .text("Countries:");
        generate_dropdown(countryMenu, countries_list);

        var variables_list = d3.map(data, function(d) {
          return d['variable'];
        }).keys();

        var variableMenu = d3.select("#variableMenu");
        variableMenu.append("p")
            .attr("class", "dropdownLabel")
            .text("Behavior Variable:");
        generate_dropdown(variableMenu, variables_list);


        function draw_lines_dots(variable) {
            var selectVariable = countries.filter(function(d) {
                return d.key == variable;
            });

            var selectLine = g.selectAll(".line")
              .data(selectVariable[0].value.country, function(d) {
                  return d ? d.values[0].variable : this.values[0].variable;
              })

            selectLine.exit().remove();

            selectLine.enter()
              .append("path")
              .transition()
              .duration(1000)
              .attr("class", "line")
              .attr("d", function(d) { return line(d.values) })
              .style("fill", "none");

            // Draw circles
            var circles = g.selectAll('circle')
              .data(data.filter(function(d) {
                  return d.variable == variable && d.frequency != 'Never or rarely';
              }), function(d) {
                  return d ? d.variable : this.variable;
              });

            circles.exit().remove();

            circles.enter()
              .append('circle')
              .transition()
              .duration(1000)
              .attr('cx', function(d) {
                  return frequency_scale(d['frequency']);
              })
              .attr('cy', function(d) {
                  return percent_scale(d['count_percent']);
              })
              .attr('r', function(d) {
                  return 1;
              });
        }


        function tabulate(data) {
          var table = d3.select("body").append("table")
          var thead = table.append("thead"),
              tbody = table.append("tbody");

          var country = data[0].country,
              variable = data[0].variable;

          variable = variable.replace(/([A-Z])/g, ' $1')
                  .replace(/^./, function(str){ return str.toUpperCase(); })

          var headerRow = thead.append("tr");

          headerRow.append("th").attr("class", "colHeader").text(country);

          // append the header row
          headerRow.selectAll(".tableCol")
              .data(data).enter()
              .append("th")
              .attr("class", "tableCol")
                .text(function(d) { return d.frequency })

          // create a row for each object in the data
          var bodyRow = tbody.append("tr");

          bodyRow.append("td").attr("class", "colHeader").text(variable);

          bodyRow.selectAll(".tableCell")
              .data(data).enter()
              .append("td")
              .attr("class", "tableCell")
                .text(function(d) { return d.count_percent + '%' })
        }

        // function updateTable(data) {

        // }

        draw_lines_dots('talkAboutMaths');

        var selectVariable = data.filter(function(d) {
                var variable = d3.select("#variableMenu select").node().value;
                var country = d3.select("#countryMenu select").node().value;
                return d.variable == variable && d.country == country;
            });

        tabulate(selectVariable);

        d3.select("table").style("margin-left", margin.left + "px");

        // Run update function when dropdown selection changes
        countryMenu.on('change', function(){
          // Find which year was selected
          var selectedCountry = d3.select(this)
            .select("select")
            .property("value")

          // Change the class of the matching line to "selected"
          var selLine = g.selectAll(".line")
                  // de-select all the lines
                  .classed("selectedLine", false)
                  .filter(function(d) {
                      return d.key === selectedCountry
                  })
                  // Set class to selected for matching line
                  .classed("selectedLine", true)

          // Change the class of the matching circle to "selected"
          var selLine = g.selectAll("circle")
                  // de-select all the lines
                  .classed("selectedCircle", false)
                  .filter(function(d) {
                      return d.country === selectedCountry
                  })
                  // Set class to selected for matching line
                  .classed("selectedCircle", true)
        })

        // Run update function when dropdown selection changes
        variableMenu.on('change', function(){

          // Find which variable was selected from the dropdown
          var selectedVariable = d3.select(this)
                  .select("select")
                  .property("value")

              // Run update function with the selected variable
              draw_lines_dots(selectedVariable)



          });

        // https://bl.ocks.org/ProQuestionAsker/b8f8c2ab12c4f21e882aeb68728216c2


      }
    </script>
  </head>
<body>
  <div id="countryMenu"> </div>
  <div id="variableMenu"> </div>
  <script type="text/javascript">

    // Change the datatype of some features
    function type(d) {
      d.count_percent = +d.count_percent;
      d.value_x = +d.value_x;
      d.value_y = +d.value_y;
      return d;
    }

    d3.csv("PISA_Math_Behavior.csv", type, draw);
  </script>
</body>
</html>
